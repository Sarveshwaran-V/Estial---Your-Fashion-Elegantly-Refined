<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outfit Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9fafb;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .tagline {
            color: #666;
            font-style: italic;
        }

        .feature-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .feature-btn {
            padding: 10px 20px;
            background-color: #e0e7ff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            color: #4f46e5;
            transition: background-color 0.3s;
        }

        .feature-btn.active {
            background-color: #4f46e5;
            color: white;
        }

        .feature-content {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #444;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background-color: #f9fafb;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #4338ca;
        }

        .image-preview {
            width: 100%;
            margin-top: 20px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }

        #preview-image, #preview-image-recommend {
            max-width: 100%;
            max-height: 300px;
            display: none;
        }

        .result-section {
            margin-top: 20px;
            display: none;
        }

        .analysis-item {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4f46e5;
        }

        .analysis-item h3 {
            margin-bottom: 15px;
            color: #4f46e5;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .analysis-item h3 .icon {
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .analysis-score {
            display: inline-block;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .score-1 { background-color: #dc2626; }
        .score-2 { background-color: #ea580c; }
        .score-3 { background-color: #d97706; }
        .score-4 { background-color: #ca8a04; }
        .score-5 { background-color: #65a30d; }
        .score-6 { background-color: #16a34a; }
        .score-7 { background-color: #059669; }
        .score-8 { background-color: #0d9488; }
        .score-9 { background-color: #0891b2; }
        .score-10 { background-color: #0284c7; }

        .analysis-content {
            padding: 10px 5px;
        }

        .analysis-section-title {
            font-weight: 600;
            color: #4f46e5;
            margin: 15px 0 8px 0;
            font-size: 1.1rem;
        }

        .analysis-subsection {
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 2px solid #e0e7ff;
        }

        .analysis-subsection-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .improvement-suggestion {
            background-color: #f0fdf4;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 3px solid #10b981;
        }

        .improvement-title {
            font-weight: 600;
            color: #065f46;
            margin-bottom: 5px;
        }

        .outfit-example {
            background-color: #eff6ff;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0 5px 0;
            border-left: 3px solid #3b82f6;
        }

        .outfit-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 5px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #4f46e5;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc2626;
            margin-top: 10px;
            padding: 10px;
            background-color: #fee2e2;
            border-radius: 5px;
            display: none;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .profile-actions button {
            width: auto;
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        .success-message {
            color: #16a34a;
            margin-top: 10px;
            padding: 10px;
            background-color: #dcfce7;
            border-radius: 5px;
            display: none;
        }

        /* Wardrobe Styles */
        .wardrobe-container {
            display: none;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .wardrobe-toggle {
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .wardrobe-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .wardrobe-item {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .wardrobe-item h4 {
            margin-bottom: 5px;
            color: #4f46e5;
        }

        .wardrobe-item p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .wardrobe-item img {
            max-width: 100%;
            max-height: 100px;
            display: block;
            margin: 10px auto;
            border-radius: 5px;
        }

        .wardrobe-item .delete-item {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 1rem;
        }

        .add-item-form {
            margin-top: 20px;
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
        }

        .use-wardrobe-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }

        .use-wardrobe-toggle input {
            width: auto;
            margin: 0;
        }

        .use-wardrobe-toggle label {
            margin: 0;
            cursor: pointer;
        }

        .wardrobe-selection {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f9fafb;
            border-radius: 8px;
        }

        .wardrobe-selection.active {
            display: block;
        }

        .wardrobe-selection-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .wardrobe-selection-item {
            background-color: #e0e7ff;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-container input {
            width: auto;
            margin: 0;
        }

        /* New styles for better output formatting */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .analysis-card {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e2e8f0;
        }

        .analysis-card-title {
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-card-content {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .pros-cons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .pros, .cons {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
        }

        .pros {
            background-color: #f0fdf4;
            border-left: 3px solid #10b981;
        }

        .cons {
            background-color: #fef2f2;
            border-left: 3px solid #ef4444;
        }

        .pros-title, .cons-title {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pros-title {
            color: #065f46;
        }

        .cons-title {
            color: #991b1b;
        }

        .outfit-combination {
            background-color: #eff6ff;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .outfit-combination-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 5px;
        }

        .rating-explanation {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        .visual-rating {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .visual-rating-bar {
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, #dc2626, #ea580c, #d97706, #ca8a04, #65a30d, #16a34a, #059669, #0d9488, #0891b2, #0284c7);
            flex-grow: 1;
            margin: 0 10px;
            position: relative;
        }

        .visual-rating-marker {
            position: absolute;
            width: 2px;
            height: 15px;
            background-color: #000;
            top: -2.5px;
            transform: translateX(-50%);
        }

        .visual-rating-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #64748b;
        }

        .color-palette {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #e2e8f0;
        }

        /* Improved outfit options styling */
        .outfit-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .outfit-option {
            background-color: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #4f46e5;
        }

        .outfit-option h5 {
            color: #4f46e5;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .outfit-option p {
            margin-bottom: 5px;
        }

        .outfit-option ul {
            margin-top: 8px;
            padding-left: 20px;
        }

        .outfit-option li {
            margin-bottom: 4px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Outfit Analyzer</h1>
            <p class="tagline">Find out what works best for your body type!</p>
        </header>

        <!-- Profile Actions -->
        <div class="profile-actions">
            <button onclick="saveProfile()"><i class="fas fa-save"></i> Save Profile</button>
            <button onclick="clearProfile()"><i class="fas fa-trash"></i> Clear Profile</button>
            <button onclick="toggleWardrobe()" id="wardrobe-toggle-btn"><i class="fas fa-wardrobe"></i> My Wardrobe</button>
        </div>

        <!-- Wardrobe Section -->
        <div class="wardrobe-container" id="wardrobe-container">
            <h3><i class="fas fa-wardrobe"></i> My Wardrobe</h3>
            <p>Add items to your wardrobe to use them in outfit analysis and recommendations.</p>
            
            <div class="wardrobe-items" id="wardrobe-items">
                <!-- Wardrobe items will be added here dynamically -->
            </div>
            
            <div class="add-item-form">
                <h4><i class="fas fa-plus"></i> Add New Item</h4>
                <div class="form-group">
                    <label for="item-name">Item Name:</label>
                    <input type="text" id="item-name" placeholder="e.g., Blue Jeans, White T-Shirt">
                </div>
                <div class="form-group">
                    <label for="item-type">Item Type:</label>
                    <select id="item-type">
                        <option value="top">Top</option>
                        <option value="bottom">Bottom</option>
                        <option value="dress">Dress</option>
                        <option value="outerwear">Outerwear</option>
                        <option value="shoes">Shoes</option>
                        <option value="accessory">Accessory</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-color">Color:</label>
                    <input type="text" id="item-color" placeholder="e.g., Navy Blue, Black">
                </div>
                <div class="form-group">
                    <label for="item-image">Upload Image (Optional):</label>
                    <input type="file" id="item-image" accept="image/*">
                </div>
                <button onclick="addWardrobeItem()"><i class="fas fa-plus"></i> Add to Wardrobe</button>
            </div>
        </div>

        <div class="feature-toggle">
            <button class="feature-btn active" onclick="showFeature('analyze')"><i class="fas fa-search"></i> Analyze Outfit</button>
            <button class="feature-btn" onclick="showFeature('recommend')"><i class="fas fa-tshirt"></i> What to Wear</button>
        </div>

        <!-- Analyze Outfit Feature -->
        <div id="analyze-feature" class="feature-content">
            <form id="analyzer-form">
                <div class="use-wardrobe-toggle">
                    <input type="checkbox" id="use-wardrobe-analyze" onchange="toggleWardrobeSelection('analyze')">
                    <label for="use-wardrobe-analyze">Use items from my wardrobe</label>
                </div>
                
                <div class="wardrobe-selection" id="wardrobe-selection-analyze">
                    <p>Select items from your wardrobe to analyze:</p>
                    <div class="wardrobe-selection-items" id="wardrobe-selection-items-analyze">
                        <!-- Wardrobe selection items will be added here dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="bodyType"><i class="fas fa-user"></i> Body Type:</label>
                    <select id="bodyType" required>
                        <option value="">Select body type</option>
                        <option value="rectangle">Rectangle</option>
                        <option value="hourglass">Hourglass</option>
                        <option value="pear">Pear</option>
                        <option value="apple">Apple</option>
                        <option value="inverted-triangle">Inverted Triangle</option>
                        <option value="athletic">Athletic</option>
                        <option value="petite">Petite</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="height"><i class="fas fa-ruler-vertical"></i> Height (cm):</label>
                    <input type="number" id="height" min="100" max="250" required>
                </div>

                <div class="form-group">
                    <label for="weight"><i class="fas fa-weight"></i> Weight (kg):</label>
                    <input type="number" id="weight" min="30" max="250" required>
                </div>

                <div class="form-group">
                    <label for="skinTone"><i class="fas fa-palette"></i> Skin Tone:</label>
                    <select id="skinTone" required>
                        <option value="">Select skin tone</option>
                        <option value="very-fair">Very Fair</option>
                        <option value="fair">Fair</option>
                        <option value="medium">Medium</option>
                        <option value="olive">Olive</option>
                        <option value="tan">Tan</option>
                        <option value="brown">Brown</option>
                        <option value="dark-brown">Dark Brown</option>
                        <option value="very-dark">Very Dark</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="hairColor"><i class="fas fa-cut"></i> Hair Color:</label>
                    <select id="hairColor" required>
                        <option value="">Select hair color</option>
                        <option value="black">Black</option>
                        <option value="dark-brown">Dark Brown</option>
                        <option value="brown">Brown</option>
                        <option value="light-brown">Light Brown</option>
                        <option value="blonde">Blonde</option>
                        <option value="red">Red</option>
                        <option value="auburn">Auburn</option>
                        <option value="gray">Gray/Silver</option>
                        <option value="white">White</option>
                        <option value="colored">Colored/Dyed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="eyeColor"><i class="fas fa-eye"></i> Eye Color:</label>
                    <select id="eyeColor" required>
                        <option value="">Select eye color</option>
                        <option value="brown">Brown</option>
                        <option value="hazel">Hazel</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="gray">Gray</option>
                        <option value="amber">Amber</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="gender"><i class="fas fa-venus-mars"></i> Gender:</label>
                    <select id="gender" required>
                        <option value="">Select gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="non-binary">Non-binary</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="outfitImage"><i class="fas fa-camera"></i> Upload Outfit Image:</label>
                    <input type="file" id="outfitImage" accept="image/*" onchange="previewImage(this, 'preview-image', 'preview-text')">
                    <div class="image-preview">
                        <img id="preview-image" src="#" alt="Preview">
                        <p id="preview-text">No image selected</p>
                    </div>
                </div>

                <button type="submit" id="analyze-button"><i class="fas fa-magic"></i> Analyze Outfit</button>
            </form>
            <div class="error-message" id="error-message"></div>
            <div class="success-message" id="success-message"></div>

            <div class="result-section" id="result-section">
                <div class="loader" id="loader"></div>
                <div class="analysis-section" id="analysis-section">
                    <!-- This will be dynamically populated by displayAnalysisResults() -->
                </div>
            </div>
        </div>

        <!-- What to Wear Feature -->
        <div id="recommend-feature" class="feature-content" style="display: none;">
            <form id="recommend-form">
                <div class="use-wardrobe-toggle">
                    <input type="checkbox" id="use-wardrobe-recommend" onchange="toggleWardrobeSelection('recommend')">
                    <label for="use-wardrobe-recommend">Use items from my wardrobe</label>
                </div>
                
                <div class="wardrobe-selection" id="wardrobe-selection-recommend">
                    <p>Select items from your wardrobe to include in recommendations:</p>
                    <div class="wardrobe-selection-items" id="wardrobe-selection-items-recommend">
                        <!-- Wardrobe selection items will be added here dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="garmentDescription"><i class="fas fa-comment-alt"></i> Describe the Garment You Want to Wear:</label>
                    <textarea id="garmentDescription" placeholder="E.g., black jeans, white t-shirt, blue cardigan, etc." required></textarea>
                </div>

                <div class="form-group">
                    <label for="garmentImage"><i class="fas fa-camera"></i> Upload Garment Image (Optional):</label>
                    <input type="file" id="garmentImage" accept="image/*" onchange="previewImage(this, 'preview-image-recommend', 'preview-text-recommend')">
                    <div class="image-preview">
                        <img id="preview-image-recommend" src="#" alt="Preview">
                        <p id="preview-text-recommend">No image selected</p>
                    </div>
                </div>

                <button type="submit" id="recommend-button"><i class="fas fa-magic"></i> Get Outfit Recommendations</button>
            </form>
            <div class="error-message" id="error-message-recommend"></div>
            <div class="success-message" id="success-message-recommend"></div>

            <div class="result-section" id="recommend-result-section">
                <div class="loader" id="loader-recommend"></div>
                <div class="analysis-section" id="recommend-analysis-section">
                    <!-- This will be dynamically populated by displayRecommendationResults() -->
                </div>
            </div>
        </div>
    </div>
<script>
    // Gemini API Key - Replace with your actual API key
    const API_KEY = 'AIzaSyCZe2UKUmNcOZwm8HXaQ_51iagGFEKQUVk';

    // Wardrobe items array
    let wardrobeItems = [];

    // Load wardrobe from localStorage
    function loadWardrobe() {
        console.log("Loading wardrobe from localStorage...");
        const savedWardrobe = localStorage.getItem('outfitAnalyzerWardrobe');
        if (savedWardrobe) {
            wardrobeItems = JSON.parse(savedWardrobe);
            renderWardrobeItems();
        }
    }

    // Save wardrobe to localStorage
    function saveWardrobe() {
        console.log("Saving wardrobe to localStorage...");
        localStorage.setItem('outfitAnalyzerWardrobe', JSON.stringify(wardrobeItems));
    }

    // Toggle wardrobe visibility
    function toggleWardrobe() {
        console.log("Toggling wardrobe visibility...");
        const wardrobeContainer = document.getElementById('wardrobe-container');
        const toggleBtn = document.getElementById('wardrobe-toggle-btn');
        
        if (wardrobeContainer.style.display === 'block') {
            wardrobeContainer.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-wardrobe"></i> My Wardrobe';
        } else {
            wardrobeContainer.style.display = 'block';
            toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Close Wardrobe';
            loadWardrobe();
        }
    }

    // Render wardrobe items
    function renderWardrobeItems() {
        console.log("Rendering wardrobe items...");
        const wardrobeItemsContainer = document.getElementById('wardrobe-items');
        wardrobeItemsContainer.innerHTML = '';
        
        if (wardrobeItems.length === 0) {
            wardrobeItemsContainer.innerHTML = '<p>Your wardrobe is empty. Add some items to get started!</p>';
            return;
        }
        
        wardrobeItems.forEach((item, index) => {
            const itemElement = document.createElement('div');
            itemElement.className = 'wardrobe-item';
            itemElement.innerHTML = `
                <button class="delete-item" onclick="deleteWardrobeItem(${index})"><i class="fas fa-times"></i></button>
                <h4>${item.name}</h4>
                <p><strong>Type:</strong> ${capitalizeFirstLetter(item.type)}</p>
                <p><strong>Color:</strong> ${item.color}</p>
                ${item.image ? `<img src="${item.image}" alt="${item.name}">` : ''}
            `;
            wardrobeItemsContainer.appendChild(itemElement);
        });
    }

    // Capitalize first letter
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    // Add new wardrobe item
    function addWardrobeItem() {
        console.log("Adding new wardrobe item...");
        const name = document.getElementById('item-name').value.trim();
        const type = document.getElementById('item-type').value;
        const color = document.getElementById('item-color').value.trim();
        const imageFile = document.getElementById('item-image').files[0];
        
        if (!name) {
            showErrorMessage('Please enter an item name', 'error-message');
            return;
        }
        
        const newItem = {
            id: Date.now(),
            name,
            type,
            color,
            image: null
        };
        
        if (imageFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                newItem.image = e.target.result;
                wardrobeItems.push(newItem);
                saveWardrobe();
                renderWardrobeItems();
                resetWardrobeForm();
                showSuccessMessage('Item added to wardrobe!', 'success-message');
                updateWardrobeSelections();
            };
            reader.onerror = function(error) {
                console.error("Error reading image file:", error);
                showErrorMessage('Error reading image file', 'error-message');
            };
            reader.readAsDataURL(imageFile);
        } else {
            wardrobeItems.push(newItem);
            saveWardrobe();
            renderWardrobeItems();
            resetWardrobeForm();
            showSuccessMessage('Item added to wardrobe!', 'success-message');
            updateWardrobeSelections();
        }
    }

    // Reset wardrobe form
    function resetWardrobeForm() {
        document.getElementById('item-name').value = '';
        document.getElementById('item-color').value = '';
        document.getElementById('item-image').value = '';
    }

    // Delete wardrobe item
    function deleteWardrobeItem(index) {
        console.log("Deleting wardrobe item at index:", index);
        if (confirm('Are you sure you want to remove this item from your wardrobe?')) {
            wardrobeItems.splice(index, 1);
            saveWardrobe();
            renderWardrobeItems();
            updateWardrobeSelections();
            showSuccessMessage('Item removed from wardrobe', 'success-message');
        }
    }

    // Toggle wardrobe selection in forms
    function toggleWardrobeSelection(feature) {
        console.log(`Toggling wardrobe selection for ${feature}...`);
        const checkbox = document.getElementById(`use-wardrobe-${feature}`);
        const selectionDiv = document.getElementById(`wardrobe-selection-${feature}`);
        
        if (checkbox.checked) {
            selectionDiv.classList.add('active');
            updateWardrobeSelections();
        } else {
            selectionDiv.classList.remove('active');
        }
    }

    // Update wardrobe selection items
    function updateWardrobeSelections() {
        console.log("Updating wardrobe selections...");
        const analyzeSelection = document.getElementById('wardrobe-selection-items-analyze');
        const recommendSelection = document.getElementById('wardrobe-selection-items-recommend');
        
        analyzeSelection.innerHTML = '';
        recommendSelection.innerHTML = '';
        
        wardrobeItems.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'wardrobe-selection-item';
            itemElement.innerHTML = `
                <div class="checkbox-container">
                    <input type="checkbox" id="analyze-${item.id}" name="wardrobe-items" value="${item.id}">
                    <label for="analyze-${item.id}">${item.name}</label>
                </div>
            `;
            analyzeSelection.appendChild(itemElement.cloneNode(true));
            
            const recommendElement = itemElement.cloneNode(true);
            recommendElement.querySelector('input').id = `recommend-${item.id}`;
            recommendElement.querySelector('label').htmlFor = `recommend-${item.id}`;
            recommendSelection.appendChild(recommendElement);
        });
    }

    // Get selected wardrobe items
    function getSelectedWardrobeItems(feature) {
        console.log(`Getting selected wardrobe items for ${feature}...`);
        const checkboxes = document.querySelectorAll(`#wardrobe-selection-items-${feature} input[type="checkbox"]:checked`);
        return Array.from(checkboxes).map(checkbox => {
            const itemId = parseInt(checkbox.value);
            return wardrobeItems.find(item => item.id === itemId);
        });
    }

    // Format wardrobe items for API prompt
    function formatWardrobeForPrompt(items) {
        if (!items || items.length === 0) return '';
        
        let promptText = "\n\nHere are the items from my wardrobe that I'm considering:\n";
        items.forEach(item => {
            promptText += `- ${item.name} (${item.type}, ${item.color})\n`;
        });
        return promptText;
    }

    // Show success message
    function showSuccessMessage(message, elementId) {
        console.log(`Showing success message: ${message}`);
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.style.display = 'block';
        setTimeout(() => {
            element.style.display = 'none';
        }, 3000);
    }

    // Show error message
    function showErrorMessage(message, elementId) {
        console.error(`Showing error message: ${message}`);
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.style.display = 'block';
    }

    // Hide error message
    function hideErrorMessage(elementId) {
        document.getElementById(elementId).style.display = 'none';
    }

    // Save profile to localStorage
    function saveProfile() {
        console.log("Saving profile to localStorage...");
        const profile = {
            bodyType: document.getElementById('bodyType').value,
            height: document.getElementById('height').value,
            weight: document.getElementById('weight').value,
            skinTone: document.getElementById('skinTone').value,
            hairColor: document.getElementById('hairColor').value,
            eyeColor: document.getElementById('eyeColor').value,
            gender: document.getElementById('gender').value,
        };
        localStorage.setItem('outfitAnalyzerProfile', JSON.stringify(profile));
        showSuccessMessage('Profile saved successfully!', 'success-message');
    }

    // Load profile from localStorage
    function loadProfile() {
        console.log("Loading profile from localStorage...");
        const profile = JSON.parse(localStorage.getItem('outfitAnalyzerProfile'));
        if (profile) {
            document.getElementById('bodyType').value = profile.bodyType;
            document.getElementById('height').value = profile.height;
            document.getElementById('weight').value = profile.weight;
            document.getElementById('skinTone').value = profile.skinTone;
            document.getElementById('hairColor').value = profile.hairColor;
            document.getElementById('eyeColor').value = profile.eyeColor;
            document.getElementById('gender').value = profile.gender;
        }
        
        // Load wardrobe as well
        loadWardrobe();
    }

    // Clear profile from localStorage
    function clearProfile() {
        console.log("Clearing profile from localStorage...");
        localStorage.removeItem('outfitAnalyzerProfile');
        showSuccessMessage('Profile cleared!', 'success-message');
        location.reload();
    }

    // Load profile when the page loads
    window.onload = function() {
        console.log("Page loaded, initializing...");
        loadProfile();
        
        // Initialize form event listeners
        document.getElementById('analyzer-form').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log("Analyze form submitted");
            analyzeOutfit().catch(error => {
                console.error("Analyze error:", error);
                showErrorMessage(`Error: ${error.message}`, 'error-message');
                document.getElementById('loader').style.display = 'none';
            });
        });

        document.getElementById('recommend-form').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log("Recommend form submitted");
            getOutfitRecommendations().catch(error => {
                console.error("Recommend error:", error);
                showErrorMessage(`Error: ${error.message}`, 'error-message-recommend');
                document.getElementById('loader-recommend').style.display = 'none';
            });
        });
    };

    // Toggle between features
    function showFeature(featureId) {
        console.log(`Showing feature: ${featureId}`);
        document.querySelectorAll('.feature-content').forEach(feature => {
            feature.style.display = 'none';
        });
        document.getElementById(featureId + '-feature').style.display = 'block';

        document.querySelectorAll('.feature-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Find and activate the correct button
        const buttons = document.querySelectorAll('.feature-btn');
        for (let btn of buttons) {
            if (btn.textContent.toLowerCase().includes(featureId)) {
                btn.classList.add('active');
                break;
            }
        }
    }

    // Preview image function
    function previewImage(input, previewImgId, previewTextId) {
        console.log("Previewing image...");
        const previewImg = document.getElementById(previewImgId);
        const previewText = document.getElementById(previewTextId);

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                previewText.style.display = 'none';
            };
            reader.onerror = function(error) {
                console.error("Error reading image:", error);
                showErrorMessage(`Error reading image: ${error}`, 'error-message');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Function to format the AI response into structured HTML
function formatAnalysisResponse(text) {
    console.log("Formatting analysis response...");
    
    // 1. Enhanced score extraction with fallback
    let mainScore = extractScoreWithFallback(text);
    
    // 2. Extract component scores (existing functionality)
    const componentScores = {};
    const scoreRegex = /(.*?)\s*(\d+)\/10/g;
    let scoreMatch;
    while ((scoreMatch = scoreRegex.exec(text)) !== null) {
        const itemName = scoreMatch[1].trim();
        if (itemName && !itemName.toLowerCase().includes('overall')) {
            componentScores[itemName] = scoreMatch[2];
        }
    }

    // 3. Extract all sections (existing functionality)
    let prosText = extractSection(text, 'Pros:', 'Cons:') || 
                  extractSection(text, 'Strengths:', 'Weaknesses:') ||
                  extractSection(text, 'Positive aspects:', 'Negative aspects:') ||
                  'No specific positive aspects mentioned.';
    
    let consText = extractSection(text, 'Cons:', 'Suggestions:') || 
                  extractSection(text, 'Weaknesses:', 'Suggestions:') ||
                  extractSection(text, 'Negative aspects:', 'Suggestions:') ||
                  'No specific negative aspects mentioned.';

    let colorAnalysis = extractSection(text, 'Color Harmony', 'Style Fit') || 
                      extractSection(text, 'Color Analysis', 'Style Analysis') ||
                      'No specific color analysis provided.';

    let styleFit = extractSection(text, 'Style Fit', 'Suggestions') || 
                  extractSection(text, 'Style Analysis', 'Recommendations') ||
                  'No specific style analysis provided.';

    let suggestions = extractSection(text, 'Suggestions') || 
                    extractSection(text, 'Recommendations') ||
                    extractSection(text, 'Improvement Suggestions') ||
                    'No specific suggestions provided.';

    let outfitIdeas = extractSection(text, 'Outfit Ideas', '') || 
                     extractSection(text, 'Example Outfits', '') ||
                     'No specific outfit examples provided.';

    return {
        mainScore,
        componentScores,
        colorAnalysis: formatColorHarmony(colorAnalysis),
        styleFit: formatStyleFit(styleFit),
        pros: formatPros(prosText),
        cons: formatCons(consText),
        suggestions: formatSuggestions(suggestions),
        outfitIdeas: formatOutfitIdeas(outfitIdeas)
    };
}

// New helper function for robust score extraction
function extractScoreWithFallback(text) {
    // Try multiple patterns to find numeric score
    const patterns = [
        /Overall Suitability\s*(\d+)\/10/i,
        /Suitability Score\s*(\d+)\/10/i,
        /Overall Rating\s*(\d+)\/10/i,
        /Rating:\s*(\d+)\/10/i,
        /Score:\s*(\d+)\/10/i,
        /(\d+)\/10\s*overall/i,
        /\b(\d+)\s*out of\s*10\b/i
    ];
    
    for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            const score = parseInt(match[1]);
            if (score >= 1 && score <= 10) {
                return score;
            }
        }
    }
    
    // If no numeric score found, analyze sentiment
    return estimateScoreFromContent(text);
}

// New helper function for sentiment-based scoring
function estimateScoreFromContent(text) {
    // Count positive and negative indicators
    const positiveTerms = ['excellent', 'great', 'perfect', 'flattering', 'works well', 'suits', 'complements', 'enhances', 'ideal'];
    const negativeTerms = ['poor', 'bad', 'unflattering', 'avoid', 'not suitable', 'clashes', 'unbalanced', 'ill-fitting'];
    
    let positiveCount = 0;
    let negativeCount = 0;
    
    const lowerText = text.toLowerCase();
    
    positiveTerms.forEach(term => {
        positiveCount += (lowerText.match(new RegExp(term, 'g')) || []).length;
    });
    
    negativeTerms.forEach(term => {
        negativeCount += (lowerText.match(new RegExp(term, 'g')) || []).length;
    });
    
    // Calculate score based on sentiment ratio
    if (positiveCount === 0 && negativeCount === 0) {
        return 5; // Neutral if no sentiment detected
    }
    
    const sentimentRatio = positiveCount / (positiveCount + negativeCount);
    return Math.max(1, Math.min(10, Math.round(1 + sentimentRatio * 9)));
}
    // Format color harmony section
    function formatColorHarmony(text) {
        if (!text) return '<p>No color analysis available.</p>';
        
        // Try to extract color palette
        const colorMatches = text.match(/(\b\w+\s*colors?\b)/gi);
        let colorPalette = '';
        if (colorMatches) {
            const uniqueColors = [...new Set(colorMatches.map(c => c.trim().toLowerCase()))];
            colorPalette = `<div class="color-palette">${
                uniqueColors.slice(0, 5).map(color => 
                    `<div class="color-swatch" style="background-color: ${getColorHex(color)}" title="${color}"></div>`
                ).join('')
            }</div>`;
        }
        
        return `<div>${colorPalette}${formatSection(text)}</div>`;
    }

    // Simple color to hex mapping
    function getColorHex(colorName) {
        const colors = {
            'black': '#000000',
            'white': '#ffffff',
            'red': '#ff0000',
            'blue': '#0000ff',
            'green': '#008000',
            'yellow': '#ffff00',
            'orange': '#ffa500',
            'purple': '#800080',
            'pink': '#ffc0cb',
            'brown': '#a52a2a',
            'gray': '#808080',
            'navy': '#000080',
            'beige': '#f5f5dc',
            'khaki': '#f0e68c',
            'olive': '#808000',
            'maroon': '#800000',
            'teal': '#008080',
            'cyan': '#00ffff',
            'magenta': '#ff00ff',
            'silver': '#c0c0c0',
            'gold': '#ffd700'
        };
        
        colorName = colorName.toLowerCase().replace(/\s+/g, '');
        return colors[colorName] || '#cccccc';
    }

    // Format style fit section
    function formatStyleFit(text) {
        if (!text) return '<p>No style analysis available.</p>';
        
        // Highlight body type mentions
        text = text.replace(/(\b\w+ body type\b)/gi, '<span style="font-weight:bold;color:#4f46e5">$1</span>');
        // Highlight fit mentions
        text = text.replace(/(\b\w+ fit\b)/gi, '<span style="font-weight:bold;color:#4f46e5">$1</span>');
        
        return formatSection(text);
    }

    // Format pros section
    function formatPros(text) {
        if (!text) return '<p>No positive aspects mentioned.</p>';
        
        // Clean up the text
        text = text.replace(/^Pros:\s*/i, '').replace(/^Strengths:\s*/i, '');
        
        // Split into bullet points if not already
        if (!text.includes('\n') && text.split(/[-•*]\s+/).length > 1) {
            const items = text.split(/[-•*]\s+/).filter(i => i.trim().length > 0);
            return `<ul>${
                items.map(item => `<li>${item.trim()}</li>`).join('')
            }</ul>`;
        }
        
        return formatSection(text);
    }

    // Format cons section
    function formatCons(text) {
        if (!text) return '<p>No negative aspects mentioned.</p>';
        
        // Clean up the text
        text = text.replace(/^Cons:\s*/i, '').replace(/^Weaknesses:\s*/i, '');
        
        // Split into bullet points if not already
        if (!text.includes('\n') && text.split(/[-•*]\s+/).length > 1) {
            const items = text.split(/[-•*]\s+/).filter(i => i.trim().length > 0);
            return `<ul>${
                items.map(item => `<li>${item.trim()}</li>`).join('')
            }</ul>`;
        }
        
        return formatSection(text);
    }

    // Format outfit ideas section
    function formatOutfitIdeas(text) {
        if (!text) return '<p>No outfit examples provided.</p>';
        
        // Extract outfit options
        const outfitOptions = [];
        const optionRegex = /Option \d+[:\s]*(.*?)(?:\n|$)/gi;
        let optionMatch;
        
        while ((optionMatch = optionRegex.exec(text)) !== null) {
            outfitOptions.push({
                description: optionMatch[1].trim()
            });
        }
        
        if (outfitOptions.length > 0) {
            return `
                <div class="outfit-options">
                    ${outfitOptions.map((option, index) => `
                        <div class="outfit-option">
                            <h5>Option ${index + 1}</h5>
                            <p>${option.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        return formatSection(text);
    }

    // Format suggestions section
    function formatSuggestions(text) {
        if (!text) return '<p>No suggestions provided.</p>';
        
        // Format improvement suggestions
        const suggestionRegex = /(?:Suggestion|Recommendation|Tip)[:\s]*(.*?)(?:\n\n|$)/gi;
        let suggestions = [];
        let suggestionMatch;
        while ((suggestionMatch = suggestionRegex.exec(text)) !== null) {
            suggestions.push(suggestionMatch[1]);
        }
        
        let suggestionsHtml = '';
        if (suggestions.length > 0) {
            suggestionsHtml = `<div class="improvement-suggestion">
                <div class="improvement-title">Key Suggestions</div>
                <ul>${
                    suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')
                }</ul>
            </div>`;
            
            // Remove suggestions from main text
            text = text.replace(suggestionRegex, '');
        }
        
        // Format remaining text
        const remainingText = formatSection(text);
        
        return `${suggestionsHtml}${remainingText}`;
    }

    // Extract a section between two headings
    function extractSection(text, startHeading, endHeading) {
        if (!text) return null;
        
        const startIndex = text.indexOf(startHeading);
        if (startIndex === -1) return null;
        
        const endIndex = endHeading ? text.indexOf(endHeading, startIndex) : text.length;
        if (endIndex === -1) return null;
        
        return text.substring(startIndex + startHeading.length, endIndex).trim();
    }

    // Format a section with bullet points and paragraphs
    function formatSection(text) {
        if (!text) return '<p>No content available.</p>';
        
        // Split into paragraphs
        let paragraphs = text.split('\n').filter(p => p.trim().length > 0);
        
        // Process each paragraph
        let html = '';
        for (let p of paragraphs) {
            // Skip empty paragraphs
            if (!p.trim()) continue;
            
            // Check if this is a bullet point list
            if (p.match(/^\s*[-•*]\s+/)) {
                const items = p.split(/[-•*]\s+/).filter(i => i.trim().length > 0);
                if (items.length > 1) {
                    html += '<ul>';
                    for (let item of items) {
                        if (item.trim()) {
                            html += `<li>${item.trim()}</li>`;
                        }
                    }
                    html += '</ul>';
                    continue;
                }
            }
            
            // Check for numbered list
            if (p.match(/^\s*\d+\.\s+/)) {
                const items = p.split(/\d+\.\s+/).filter(i => i.trim().length > 0);
                if (items.length > 1) {
                    html += '<ol>';
                    for (let item of items) {
                        if (item.trim()) {
                            html += `<li>${item.trim()}</li>`;
                        }
                    }
                    html += '</ol>';
                    continue;
                }
            }
            
            // Regular paragraph
            if (p.trim()) {
                // Highlight important terms
                p = p.replace(/(\b\w+ color\b)/gi, '<span style="font-weight:bold;color:#4f46e5">$1</span>');
                p = p.replace(/(\b\w+ body type\b)/gi, '<span style="font-weight:bold;color:#4f46e5">$1</span>');
                p = p.replace(/(\d+\/10)/g, '<span class="analysis-score">$1</span>');
                html += `<p>${p}</p>`;
            }
        }
        
        return html || `<p>${text}</p>`;
    }

    // Function to make API call for outfit analysis
    async function analyzeOutfit() {
        console.log("Starting outfit analysis...");
        const bodyType = document.getElementById('bodyType').value;
        const height = document.getElementById('height').value;
        const weight = document.getElementById('weight').value;
        const skinTone = document.getElementById('skinTone').value;
        const hairColor = document.getElementById('hairColor').value;
        const eyeColor = document.getElementById('eyeColor').value;
        const gender = document.getElementById('gender').value;
        const imageFile = document.getElementById('outfitImage').files[0];
        const useWardrobe = document.getElementById('use-wardrobe-analyze').checked;
        const selectedWardrobeItems = useWardrobe ? getSelectedWardrobeItems('analyze') : [];

        if (!imageFile && selectedWardrobeItems.length === 0) {
            throw new Error("Please upload an outfit image or select items from your wardrobe!");
        }

        // Validate all fields
        if (!bodyType || !height || !weight || !skinTone || !hairColor || !eyeColor || !gender) {
            throw new Error("Please fill in all required fields!");
        }

        // Show loader and hide previous results
        document.getElementById('loader').style.display = 'block';
        document.getElementById('analysis-section').style.display = 'none';
        hideErrorMessage('error-message');
        document.getElementById('result-section').style.display = 'block';

        // Prepare the base prompt
        let promptText = `Analyze this outfit for a person with the following details:
        - Body Type: ${bodyType}
        - Height: ${height} cm
        - Weight: ${weight} kg
        - Skin Tone: ${skinTone}
        - Hair Color: ${hairColor}
        - Eye Color: ${eyeColor}
        - Gender: ${gender}`;

        // Add wardrobe items to prompt if selected
        if (selectedWardrobeItems.length > 0) {
            promptText += formatWardrobeForPrompt(selectedWardrobeItems);
        }

        promptText += `\n\nProvide a detailed analysis including:
        1. Overall suitability score (1-10) - be specific about the rating
        2. Color harmony with their features (what works well and what doesn't)
        3. Style fit for their body type (how the cut and style flatters their shape)
        4. Pros (what works well in this outfit)
        5. Cons (what could be improved)
        6. Specific suggestions for improvements
        7. Example outfit combinations that would work better
        
        Format your response with clear headings for each section. Be detailed and specific in your analysis.`;

        // Prepare the API request payload
        const requestBody = {
            contents: [
                {
                    parts: [
                        { text: promptText }
                    ]
                }
            ]
        };

        console.log("Request payload:", requestBody);

        // Add image to request if uploaded
        if (imageFile) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function () {
                    try {
                        const base64Image = reader.result.split(',')[1];
                        requestBody.contents[0].parts.push({
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64Image
                            }
                        });

                        console.log("Making API request with image...");
                        const analysis = await makeAnalysisRequest(requestBody);
                        displayAnalysisResults(analysis);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = function(error) {
                    console.error("Error reading image:", error);
                    reject(new Error(`Error reading image file: ${error.message}`));
                };
                reader.readAsDataURL(imageFile);
            });
        } else {
            // No image, just text analysis
            try {
                console.log("Making API request without image...");
                const analysis = await makeAnalysisRequest(requestBody);
                displayAnalysisResults(analysis);
            } catch (error) {
                throw error;
            }
        }
    }

    // Display formatted analysis results
    function displayAnalysisResults(analysis) {
        console.log("Displaying analysis results:", analysis);
        const analysisHTML = `
            <div class="analysis-item">
                <h3><i class="fas fa-star"></i> Overall Rating: 
                    <span class="analysis-score score-${analysis.mainScore}">${analysis.mainScore}/10</span>
                </h3>
                <div class="visual-rating">
                    <span>1</span>
                    <div class="visual-rating-bar">
                        <div class="visual-rating-marker" style="left: ${analysis.mainScore * 10}%"></div>
                    </div>
                    <span>10</span>
                </div>
                <div class="visual-rating-labels">
                    <span>1 (Poor)</span>
                    <span>5 (Average)</span>
                    <span>10 (Excellent)</span>
                </div>
                <div class="rating-explanation">
                    ${getRatingExplanation(analysis.mainScore)}
                </div>
            </div>

            <div class="analysis-grid">
                <!-- Color Analysis Card -->
                <div class="analysis-card">
                    <h4><i class="fas fa-palette"></i> Color Harmony</h4>
                    <div class="analysis-card-content">
                        ${analysis.colorAnalysis}
                    </div>
                </div>
                
                <!-- Style Fit Card -->
                <div class="analysis-card">
                    <h4><i class="fas fa-ruler-combined"></i> Style Fit</h4>
                    <div class="analysis-card-content">
                        ${analysis.styleFit}
                    </div>
                </div>
                
                <!-- Pros Card -->
                <div class="analysis-card">
                    <h4><i class="fas fa-thumbs-up"></i> What Works</h4>
                    <div class="analysis-card-content">
                        ${analysis.pros}
                    </div>
                </div>
                
                <!-- Cons Card -->
                <div class="analysis-card">
                    <h4><i class="fas fa-thumbs-down"></i> What Could Improve</h4>
                    <div class="analysis-card-content">
                        ${analysis.cons}
                    </div>
                </div>
            </div>

            <div class="analysis-item">
                <h3><i class="fas fa-lightbulb"></i> Suggestions & Outfit Ideas</h3>
                <div class="analysis-content">
                    ${analysis.suggestions}
                    ${analysis.outfitIdeas}
                </div>
            </div>
        `;

        document.getElementById('analysis-section').innerHTML = analysisHTML;
        document.getElementById('analysis-section').style.display = 'block';
        document.getElementById('loader').style.display = 'none';
    }

    // Helper function for rating explanation
    function getRatingExplanation(score) {
        const explanations = {
            1: "This outfit doesn't work well for your body type and features.",
            2: "This outfit has significant issues that need to be addressed.",
            3: "This outfit has several problems that affect its suitability.",
            4: "This outfit has some issues but could work with modifications.",
            5: "This outfit is average - it works but could be improved.",
            6: "This outfit is above average - it works well but has minor issues.",
            7: "This is a good outfit that flatters your features.",
            8: "This is a very good outfit that works well for you.",
            9: "This is an excellent outfit that highlights your best features.",
            10: "This is a perfect outfit that's ideally suited to you."
        };
        
        const roundedScore = Math.min(10, Math.max(1, Math.round(score)));
        return explanations[roundedScore] || "Outfit evaluation based on your profile.";
    }

    // Make the analysis API request
    async function makeAnalysisRequest(requestBody) {
        console.log("Making analysis API request...");
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            console.log("API response status:", response.status);
            
            if (!response.ok) {
                const errorData = await response.json();
                console.error("API error response:", errorData);
                throw new Error(`API request failed: ${errorData.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            console.log("API response data:", data);

            if (data.candidates && data.candidates.length > 0) {
                const analysisText = data.candidates[0].content.parts[0].text;
                console.log("Analysis text received:", analysisText);
                return formatAnalysisResponse(analysisText);
            } else {
                throw new Error('No analysis found in the response.');
            }
        } catch (error) {
            console.error("Error in makeAnalysisRequest:", error);
            document.getElementById('loader').style.display = 'none';
            throw error;
        }
    }

    // Function to make API call for outfit recommendations
    async function getOutfitRecommendations() {
        console.log("Getting outfit recommendations...");
        const bodyType = document.getElementById('bodyType').value;
        const height = document.getElementById('height').value;
        const weight = document.getElementById('weight').value;
        const skinTone = document.getElementById('skinTone').value;
        const hairColor = document.getElementById('hairColor').value;
        const eyeColor = document.getElementById('eyeColor').value;
        const gender = document.getElementById('gender').value;
        const garmentDescription = document.getElementById('garmentDescription').value;
        const imageFile = document.getElementById('garmentImage').files[0];
        const useWardrobe = document.getElementById('use-wardrobe-recommend').checked;
        const selectedWardrobeItems = useWardrobe ? getSelectedWardrobeItems('recommend') : [];

        if (!garmentDescription && selectedWardrobeItems.length === 0) {
            throw new Error("Please describe the garment you want to wear or select items from your wardrobe!");
        }

        // Validate all fields
        if (!bodyType || !height || !weight || !skinTone || !hairColor || !eyeColor || !gender) {
            throw new Error("Please fill in all required profile fields first!");
        }

        // Show loader
        document.getElementById('loader-recommend').style.display = 'block';
        document.getElementById('recommend-analysis-section').style.display = 'none';
        hideErrorMessage('error-message-recommend');
        document.getElementById('recommend-result-section').style.display = 'block';

        // Prepare the base prompt
        let promptText = `Based on ${
            garmentDescription ? `this garment description "${garmentDescription}"` : 'these selected wardrobe items'
        }, recommend a complete outfit for a person with the following details:
        - Body Type: ${bodyType}
        - Height: ${height} cm
        - Weight: ${weight} kg
        - Skin Tone: ${skinTone}
        - Hair Color: ${hairColor}
        - Eye Color: ${eyeColor}
        - Gender: ${gender}`;

        // Add wardrobe items to prompt if selected
        if (selectedWardrobeItems.length > 0) {
            promptText += formatWardrobeForPrompt(selectedWardrobeItems);
        }

        promptText += `\n\nProvide detailed recommendations including:
        1. How suitable the described garment is for this body type (score 1-10)
        2. Specific items to pair with the described garment
        3. Style suggestions for this person's body type and features
        4. Color combinations that would work well
        5. Accessory ideas to complete the look
        6. Complete outfit ideas incorporating the described garment
        
        Format your response with clear headings for each section. Be specific and provide multiple options when possible.`;

        // Prepare the API request payload
        const requestBody = {
            contents: [
                {
                    parts: [
                        { text: promptText }
                    ]
                }
            ]
        };

        console.log("Recommendation request payload:", requestBody);

        // Add image to request if uploaded
        if (imageFile) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function () {
                    try {
                        const base64Image = reader.result.split(',')[1];
                        requestBody.contents[0].parts.push({
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64Image
                            }
                        });

                        console.log("Making recommendation API request with image...");
                        const recommendation = await makeRecommendationRequest(requestBody);
                        displayRecommendationResults(recommendation);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = function(error) {
                    console.error("Error reading image:", error);
                    reject(new Error(`Error reading image file: ${error.message}`));
                };
                reader.readAsDataURL(imageFile);
            });
        } else {
            // No image, just text analysis
            try {
                console.log("Making recommendation API request without image...");
                const recommendation = await makeRecommendationRequest(requestBody);
                displayRecommendationResults(recommendation);
            } catch (error) {
                throw error;
            }
        }
    }

    // Display recommendation results
    function displayRecommendationResults(recommendation) {
        console.log("Displaying recommendation results:", recommendation);
        const analysisHTML = `
            <div class="analysis-item">
                <h3><i class="fas fa-star"></i> Garment Suitability: 
                    <span class="analysis-score score-${recommendation.mainScore}">${recommendation.mainScore}/10</span>
                </h3>
                <div class="visual-rating">
                    <span>1</span>
                    <div class="visual-rating-bar">
                        <div class="visual-rating-marker" style="left: ${recommendation.mainScore * 10}%"></div>
                    </div>
                    <span>10</span>
                </div>
                <div class="visual-rating-labels">
                    <span>1 (Poor)</span>
                    <span>5 (Average)</span>
                    <span>10 (Excellent)</span>
                </div>
                <div class="rating-explanation">
                    ${getRatingExplanation(recommendation.mainScore)}
                </div>
            </div>

            <div class="analysis-grid">
                <!-- Recommended Items Card -->
                <div class="analysis-card">
                    <h4><i class="fas fa-list-ul"></i> Recommended Items</h4>
                    <div class="analysis-card-content">
                        ${recommendation.pros}
                    </div>
                </div>
                
                <!-- Style Suggestions Card -->
                <div class="analysis-card">
                    <h4><i class="fas fa-tshirt"></i> Style Suggestions</h4>
                    <div class="analysis-card-content">
                        ${recommendation.styleFit}
                    </div>
                </div>
                
                <!-- Color Combinations Card -->
                <div class="analysis-card">
                    <h4><i class="fas fa-palette"></i> Color Combinations</h4>
                    <div class="analysis-card-content">
                        ${recommendation.colorAnalysis}
                    </div>
                </div>
                
                <!-- Accessory Ideas Card -->
                <div class="analysis-card">
                    <h4><i class="fas fa-shoe-prints"></i> Accessory Ideas</h4>
                    <div class="analysis-card-content">
                        ${recommendation.cons}
                    </div>
                </div>
            </div>

            <div class="analysis-item">
                <h3><i class="fas fa-lightbulb"></i> Complete Outfit Ideas</h3>
                <div class="analysis-content">
                    ${recommendation.suggestions}
                    ${recommendation.outfitIdeas}
                </div>
            </div>
        `;

        document.getElementById('recommend-analysis-section').innerHTML = analysisHTML;
        document.getElementById('recommend-analysis-section').style.display = 'block';
        document.getElementById('loader-recommend').style.display = 'none';
    }

    // Make the recommendation API request
    async function makeRecommendationRequest(requestBody) {
        console.log("Making recommendation API request...");
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            console.log("API response status:", response.status);
            
            if (!response.ok) {
                const errorData = await response.json();
                console.error("API error response:", errorData);
                throw new Error(`API request failed: ${errorData.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            console.log("API response data:", data);

            if (data.candidates && data.candidates.length > 0) {
                const recommendationText = data.candidates[0].content.parts[0].text;
                console.log("Recommendation text received:", recommendationText);
                return formatAnalysisResponse(recommendationText);
            } else {
                throw new Error('No recommendations found in the response.');
            }
        } catch (error) {
            console.error("Error in makeRecommendationRequest:", error);
            document.getElementById('loader-recommend').style.display = 'none';
            throw error;
        }
    }
</script>
</body>
</html>